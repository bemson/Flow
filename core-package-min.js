/* Core (Flow Package) v0.X | github.com/bemson | (c) 2011, MIT */
!function(a,b,c){function i(a){return a!=null&&/\w/.test(a)}function j(a){var b=typeof a;return b==="object"&&~(new Object).toString.call(a).indexOf("y")?"array":b}function k(a){g.unshift(a),d.actives.unshift(a.proxy)}function l(){g.shift(),d.actives.shift()}if(!a||~a.pkg().indexOf("core"))return;var d=a.pkg("core"),e=new genData(function(a,d,e,f,g,h){var j=this,k=1,l={name:j.name,value:j.value,use:1};g.omit=1,j.O=typeof d=="object",j.A=d instanceof b,e?e.A?j.O&&(k=0):g.scan=0:(h.keys||(h.keys={}),j.O&&(k=0));if(k){if(!e||e.A)l.name=d,l.value=c,l.use=0;i(l.name)&&(l.name+="",h.keys.hasOwnProperty(l.name)&&f.splice(h.keys[l.name],1),h.keys[l.name]=f.push(l)-1)}}),f=new genData(function(a,b,c,d,e){var f=this,g="/";f.set=0,f.parent=c,f.done=0,typeof b=="string"&&(~b.indexOf(g)?f.value=b.split(g):b.charAt(0)==="["&&(f.value=b.slice(1,-1).split("|"),f.set=1)),typeof f.value=="string"?(c&&c.set&&(f.set=1,c.last=f),f.first=!d.length):e.omit=1}),g=[],h=b.prototype;h.every||(h.every=function(a,b){for(var c=0,d=this.length;c<d;c++)if(!a.call(b,this[c],c,this))return!1;return!0}),h.indexOf||(h.indexOf=function(a,b){for(var c=b|0,d=this.length;c<d;c++)if(this[c]===a)return c;return-1}),d.actives=[],d.events=["on","in","out","over","bover"],d.attributeKey=/^_/,d.invalidKey=/^\W+$|^toString$|^[@\[]|[\/\|]/,d.init=function(){var a=this;a.args=[],a.calls=[],a.route=[],a.data={},a.delay={},a.cache={indexOf:{}},a.trust=0,a.locked=0,a.stateIds={},a.pending=0,a.penders={},a.parents=[],a.targets=[],a.phase=0,a.states.forEach(function(b,c){var f=c&&a.states[b.parentIndex];a.stateIds[b.path]=c,b.pkg=a,b.pendable=f&&!f.pendable?0:b.attributes.hasOwnProperty("_pendable")?!!b.attributes._pendable:1,b.isRoot=c<2?1:!!b.attributes._root,b.rootIndex=b.isRoot?b.index:f.rootIndex,b.restrict=!!(b.attributes._restrict||f&&f.restrict),b.map=function(){var b=[].slice.call(arguments),d=a.proxy.pkgs.core;return b.unshift(c),d.target.apply(d,b)},b.data=e(b.attributes._data),b.index&&(f.map[b.name]=b.map),b.map.toString=function(){return b.path},b.fncs=d.events.map(function(a){return a="_"+a,typeof b.attributes[a]=="function"?b.attributes[a]:0}),!b.fncs[0]&&typeof b.value=="function"&&(b.fncs[0]=b.value)})},d.prototype={indexOf:function(a,b){var c=this,d=c.states,e=c.stateIds,g,h,i,j,k,l=-1;b=b||c.states[c.tank.currentIndex];switch(typeof a){case"object":a!==null&&(a=a.index);case"number":d[a]&&(l=a);break;case"function":a+="";case"string":if(a=="")break;if(a==="..//"||a==="//")l=a==="//"?1:0;else{j=a.match(/^(?:(?:\.{1,2}|[@\[][^\/]+)\/?)+/);if(j){if(!c.cache.indexOf.hasOwnProperty(a+b.index)&&!c.cache.indexOf.hasOwnProperty(a)){g=a.substr(j[0].length),i=0,j=f(j[0]),l=b.index;while((h=d[l])&&j.length){k=j.shift();if(!k.set||!k.parent.done){switch(k.value){case"@child":l=h.firstChildIndex;break;case"@next":l=h.nextIndex;break;case"@parent":case"..":l=h.parentIndex;break;case"@previous":l=h.previousIndex;break;case"@root":l=h.rootIndex;break;case"@program":case"@flow":k.first&&(i=1),l=~k.value.indexOf("f")?0:1;break;case"@oldest":case"@youngest":l=d[h.parentIndex]?d[h.parentIndex][~k.value.indexOf("y")?"firstChildIndex":"lastChildIndex"]:-1;break;case"@self":case".":l=h.index;break;default:k.value&&(l=-1)}k.set&&(l>-1?k.parent.done=1:k.parent.last!==k&&(l=h.index))}}l=h&&(!g||(h=d[e[h.path+g.replace(/([^\/])$/,"$1/")]]))?h.index:-1,c.cache.indexOf[a+(i?"":b.index)]=l}l=c.cache.indexOf.hasOwnProperty(a+b.index)?c.cache.indexOf[a+b.index]:c.cache.indexOf[a]}else a.charAt(0)!=="/"?a=b.path+a:a.charAt(1)!=="/"&&(a=d[b.rootIndex].path+a.substr(1)),a.slice(-1)!=="/"&&(a+="/"),l=e.hasOwnProperty(a)?e[a]:-1}}return l},vetIndexOf:function(a,b){var c=this,d=c.indexOf(a,b);return b=b||c.states[c.tank.currentIndex],~d&&(c.trust||b.canTgt(c.states[d]))?d:-1},getData:function(a,b){var c=this;return i(a)&&(c.data.hasOwnProperty(a)?c.data[a]:c.data[a]={name:a,values:arguments.length>1?[b]:[]})},go:function(){var a=this;return a.pause=0,a.pending?0:a.tank.go(a.targets[0])}},d.onBegin=function(a){var b=this,c=b.delay.callback,d=g[0];d&&d.states[d.tank.currentIndex].pendable&&!b.penders[d.tank.id]&&(b.penders[d.tank.id]=1,d.pending++,~b.parents.indexOf(d)||b.parents.unshift(d)),k(b),clearTimeout(b.delay.timer),b.delay.callback=0,c&&(b.trust=1,c.call(b.proxy),b.trust=0)},d.onTraverse=function(a,b){var c=this,d=c.tank,e=c.states[d.currentIndex];c.trust=1,c.outState&&(c.outState.scopeData(1),c.outState=0);switch(b){case 1:e.scopeData();break;case 2:c.outState=e}c.phase=b,e.index!==c.route.slice(-1)[0]&&c.route.push(e.index),~d.targetIndex||c.targets.shift(),e.fncs[b]&&(c.calls.push(e.index+"."+b),c.result=e.fncs[b].apply(c.proxy,c.targets.length?[]:c.args)),c.pending&&d.stop(),c.trust=0},d.onEnd=function(a){var b=this,c=b.tank,d=!b.pause&&!b.pending;b.phase?l():d&&b.targets.length?c.go(b.targets[0]):(l(),d&&(b.args=[],b.calls=[],b.route=[],b.parents.length&&(b.parents.forEach(function(a){b.penders[a.tank.id]=0,a.pending--}),c.post(function(){var a=[].concat(b.parents);b.parents=[],a.forEach(function(a){a.pending|a.pause||a.go()})}))))},d.state.canTgt=function(a){var b=this;return!b.restrict||b!==a&&!a.path.indexOf(b.path)},d.state.scopeData=function(a){var b=this,c=b.pkg;b.data.forEach(function(b){var d=c.getData(b.name);a?(d.values.shift(),d.values.length||delete c.data[b.name]):d.values.unshift(b.use?b.value:d.values[0])})},d.proxy.map=function(){return d(this).states[1].map},d.proxy.query=function(a){var b=d(this),c=[];return a&&[].slice.call(arguments).every(function(a){var d=b.vetIndexOf(a),e=0;return~d&&(c.push(b.states[d].path),e=1),e})?c.length>0?c:c[0]:!1},d.proxy.lock=function(a){var b=d(this);return arguments.length?b.trust?(b.locked=!!a,!0):!1:!!b.locked},d.proxy.data=function(a,b){var c=d(this),e=arguments.length,f,g=!1;if(e)typeof a=="string"&&/\w/.test(a)&&(f=c.getData(a),e>1?(f.values[0]=b,g=!0):g=f.values[0]);else{g=[];for(f in c.data)c.data.hasOwnProperty(f)&&g.push(f);g.sort()}return g},d.proxy.args=function(a,b){var e=d(this),f=e.args,g=arguments.length,h=j(a);if(g===1||g&&(e.trust||!e.locked)){if(h==="array")return e.args=[].concat(a),!0;if(h==="number"&&!isNaN(a)&&a>=0)return g>1?(b===c&&a===f.length-1?f.pop():f[a]=b,!0):f[a]}else if(!g)return[].concat(f);return!1},d.proxy.target=function(a){var b=d(this),e=b.trust||!b.locked?b.vetIndexOf(a):-1;if(~e)b.args=[].slice.call(arguments).slice(1),b.targets=[e],b.go();else return!1;return b.trust?!b.pending:b.phase||b.pause?!1:b.result===c||b.result},d.proxy.go=function(a){var b=d(this),c=b.pause,e=[],f=0;return(b.trust||!b.locked)&&[].slice.call(arguments).every(function(a){var c=b.vetIndexOf(a);return e.push(c),~c})&&(e.length&&(e.slice(-1)[0]===b.targets[0]&&e.pop(),b.targets=e.concat(b.targets)),f=b.go()||c),!!f},d.proxy.wait=function(){var a=d(this),b=arguments,c=b.length,e=c<2,f=e?0:b[0],g=typeof f=="function",h=a.indexOf(f),i=b[c-1],j=0;return a.trust&&(!c||i>=0&&typeof i=="number"&&(e||~h||g))&&(a.pause=1,a.tank.stop(),clearTimeout(a.delay.timer),a.delay.timer=c?setTimeout(function(){!e&&~h?a.proxy.pkgs.core.target(h):(g&&(a.delay.callback=f),a.go())},~~i):1,j=1),!!j},d.proxy.status=function(){var b=this,c={};return a.pkg().forEach(function(d){var e=a.pkg(d),f,g;if(typeof e.addStatus=="function"&&typeof (f=e.addStatus.call(e(b),c))=="object")for(g in f)f.hasOwnProperty(g)&&(c[g]=f[g])}),c},d.addStatus=function(a){function f(a){return b.states[a].path}var b=this,c=b.states[b.tank.currentIndex],e=b.trust|b.pause|b.pending;return{trust:!!b.trust,loops:Math.max((b.calls.join().match(new RegExp("\\b"+c.index+"."+b.phase,"g"))||[]).length-1,0),depth:c.depth,paused:!!b.pause,pending:!!b.pending,pendable:!!c.pendable,targets:b.targets.map(f),route:b.route.map(f),path:c.path,index:c.index,phase:e?d.events[b.phase]:"",state:c.name}}}(typeof require!="undefined"?require("Flow.js").Flow:Flow,Array);